"use strict";var addressValid={errObj:".totalerror",errInfo:"Please enter the correct format",nullInfo:"This is a required field",addressObj:".shippingAddres",continueObj:".continue",phoneReg:/^[0-9]{10,12}$/,init:function(e){addressValid.addressObj=e&&e.addressObj||addressValid.addressObj,addressValid.errObj=e&&e.errObj||addressValid.errObj,addressValid.continueObj=e&&e.continueObj||addressValid.continueObj,addressValid.errInfo=e&&e.errInfo||addressValid.errInfo,addressValid.nullInfo=e&&e.nullInfo||addressValid.nullInfo,$(addressValid.addressObj).on("focus","input[required],select[required]",function(){addressValid.hideError(this)}),$(addressValid.addressObj).on("blur","input[required],select[required]",function(){addressValid.validData(this)}),$(addressValid.addressObj).on("click",addressValid.continueObj,function(){addressValid.savecontinue(e&&e.nextFun)})},showError:function(e,d){$(e).addClass("border").siblings(addressValid.errObj).html(d).show()},hideError:function(e){$(e).removeClass("border").siblings(addressValid.errObj).hide()},validData:function(e){var d=$(e).val(),s=$(e).prop("id");if(!d)return addressValid.showError(e,addressValid.nullInfo),!1;switch(s){case"email":if(!emailReg.test(d))return addressValid.showError(e,addressValid.errInfo),!1;break;case"phone":if(!addressValid.phoneReg.test(d))return addressValid.showError(e,addressValid.errInfo),!1}addressValid.hideError(e)},savecontinue:function(e){var d=$(addressValid.addressObj+" input[required]"),s=$(addressValid.addressObj+" select[required]"),a=!0;d.each(function(){addressValid.validData(this),$(this).hasClass("border")&&(a=!1)}),s.each(function(){addressValid.validData(this),$(this).hasClass("border")&&(a=!1)}),a&&e&&e()}},addressField={email:$("#email"),phone:$("#phone"),phone_standby:$("#altematePhone"),firstname:$("#firstName"),lastname:$("#lastName"),address_1:$("#address1"),address_2:$("#address2"),postcode:$("#zipCode"),country:$("#country"),zone:$("#state"),city:$("#city"),address_id:$("#address_id"),shipping_id:$("#shipping_id"),billing_id:$("#billing_id"),code:$("#code"),product_id:$("#product_id"),coupon_code:$("#code")},addressEnum={shipping:1,billing:2},getAddressData=function(){return{email:addressField.email.val(),phone:addressField.phone.val(),phone_standby:addressField.phone_standby.val(),firstname:addressField.firstname.val(),lastname:addressField.lastname.val(),address_1:addressField.address_1.val(),address_2:addressField.address_2.val()||"",postcode:addressField.postcode.val(),country_id:addressField.country.val(),zone_id:addressField.zone.val(),city:addressField.city.val(),address_id:addressField.address_id.val()||"",coupon_code:addressField.coupon_code.val()||""}},updatePrice=function(e,d,s,a){e&&$(".shipping-price").html(currency+e),s&&($(".save").show(),$(".save .save-price").html("-"+currency+s)),d&&$(".taxprice").html(d),$(".right_list .total").html(currency+a)},addressOperate={redirectUrl:"",shippingInfo:"",billingInfo:"",updateInfo:"",operate:"add",createAddress:function(a,i){var e=a==addressEnum.shipping?"/api/address/createShipping":"/api/address/createBilling";$.ajax({url:e,type:"POST",data:getAddressData(),success:function(s){ajaxSuccess(s,function(){if(s.data){var e=s.data.id||s.data.address_id;if(a==addressEnum.shipping){addressOperate.shippingInfo=s.data,addressField.shipping_id.val(e);var d=s.data.total;updatePrice(d.shipping,d.tax,d.coupon_price,d.total)}else a==addressEnum.billing&&(addressOperate.billingInfo=s.data,addressField.billing_id.val(e));addressOperate.updateInfo=s.data,addressOperate.operate="edit",i?addressOperate.getAllAddress(i):addressOperate.redirectUrl&&(window.location.href=addressOperate.redirectUrl)}})}})},createShipping:function(e){addressOperate.createAddress(addressEnum.shipping,e)},createBilling:function(e){addressOperate.createAddress(addressEnum.billing,e)},updateAddress:function(a,i){var e=a==addressEnum.shipping?"/api/address/updateShipping":"/api/address/updateBilling";$.ajax({url:e,type:"POST",data:getAddressData(),success:function(s){ajaxSuccess(s,function(){if(s.data){var e=s.data.id||s.data.address_id;if(a==addressEnum.shipping){addressField.shipping_id.val(e);var d=s.data.total;updatePrice(d.shipping,d.tax,d.coupon_price,d.total)}else a==addressEnum.billing&&addressField.billing_id.val(e);addressOperate.updateInfo=s.data,addressOperate.operate="edit",addressOperate.getAllAddress(i)}})}})},updateShipping:function(e){addressOperate.updateAddress(addressEnum.shipping,e)},updateBilling:function(e){addressOperate.updateAddress(addressEnum.billing,e)},getAddress:function(d){$.ajax({url:"/api/address/getAddress",type:"POST",data:getAddressData(),success:function(e){ajaxSuccess(e,function(){e.data&&(addressOperate.shippingInfo=e.data.shipping,addressOperate.billingInfo=e.data.billing,d&&d())})}})},getAllAddress:function(d){$.ajax({url:"/api/address/getAllAddress",type:"POST",success:function(e){ajaxSuccess(e,function(){e.data&&(addressOperate.shippingInfo=e.data.shipping,addressOperate.billingInfo=e.data.billing,d&&d())})}})}},fillUpAddress=function(e,d){if(e){var s=e[0]||e;if(1<e.length)for(var a=0;a<e.length;a++)"shipping"==e[a].type&&e[a].id==addressField.shipping_id.val()?s=e[a]:"billing"==e[a].type&&e[a].id==addressField.billing_id.val()&&(s=e[a]);var i=s.id;if(!d){var r="<option selected value='"+i+"'>"+s.firstname+" "+s.lastname+", "+s.address_1+", "+(s.address_2?s.address_2+", ":"");r+=s.postcode+", "+(s.zone_name||$("#state [value="+s.zone_id+"]").html())+", "+(s.country_name||$("#country [value="+s.country_id+"]").html())+", "+s.phone+"</option>";for(a=0;a<e.length;a++)i!=e[a].id&&(r+="<option value='"+e[a].id+"'>"+e[a].firstname+" "+e[a].lastname+", "+e[a].address_1+", "+(e[a].address_2?e[a].address_2+", ":""),r+=e[a].postcode+", "+e[a].zone_name+", "+e[a].country_name+", "+e[a].phone+"</option>");r+="<option value='-1'>Add a new address</option>",$(".editAddress #select_more").html(r)}addressField.email.val(s.email),addressField.firstname.val(s.firstname),addressField.lastname.val(s.lastname),addressField.city.val(s.city),addressField.phone.val(s.phone),addressField.phone_standby.val(s.phone_standby),addressField.postcode.val(s.postcode),addressField.zone.val(s.zone_id),addressField.address_1.val(s.address_1),addressField.address_2.val(s.address_2),addressField.country.val(s.country_id),addressField.address_id.val(i)}},fillUpShippingAddress=function(){fillUpAddress(addressOperate.shippingInfo)},fillUpBillingAddress=function(){fillUpAddress(addressOperate.billingInfo)},clearAddress=function(){addressField.email.val(""),addressField.firstname.val(""),addressField.lastname.val(""),addressField.city.val(""),addressField.phone.val(""),addressField.phone_standby.val(""),addressField.postcode.val(""),addressField.zone.val(""),addressField.address_1.val(""),addressField.address_2.val(""),addressField.country.val("")},operateAddress=function(){checkLogin?$(".tableLeft .continue").hasClass("shipping")?"add"==addressOperate.operate?addressOperate.createShipping(operateAddressSucc):"edit"==addressOperate.operate&&addressOperate.updateShipping(operateAddressSucc):"add"==addressOperate.operate?addressOperate.createBilling(operateAddressSucc):"edit"==addressOperate.operate&&addressOperate.updateBilling(operateAddressSucc):$(".tableLeft .continue").hasClass("shipping")?addressOperate.createShipping(operateAddressSucc):addressOperate.createBilling(operateAddressSucc)},operateAddressSucc=function(){$(".editAddress").hide(),$(".common-bg").hide(),closeBox();var e=$(".tableLeft .continue").hasClass("shipping")?"shipping":"billing",d=addressOperate.updateInfo;if("edit"==addressOperate.operate?$(".addressTittle span."+e).removeClass("add").addClass("edit").html("Edit"):"add"==addressOperate.operate&&$(".addressTittle span."+e).removeClass("edit").addClass("add").html("Add"),d){var s="<li>"+d.firstname+" "+d.lastname+"</li>";s+="<li>"+d.address_1+", "+(d.address_2||"")+"</li>",s+="<li>"+($("#state [value="+d.zone_id+"]").html()||"")+", "+d.city+"  "+d.postcode+"</li>",s+="<li>"+($("#country [value="+d.country_id+"]").html()||"")+"</li>",s+="<li>"+d.phone+"</li>","billing"==e&&(s+="<li>"+d.email+"</li>"),$(".addressEdit .addressDetail."+e+" ul").html(s),"billing"==e?(addressField.billing_id.val(d.id||d.address_id),$(".payment .billing.addressDetail").removeClass("border")):"shipping"==e&&(addressField.shipping_id.val(d.id||d.address_id),$(".payment .shipping.addressDetail").removeClass("border"))}},clearCode=function(){$(".save").hide(),$(".save .save-price").html(""),$(".right_list .total").html(currency+$("#original-price").val()),$(".codeInput").show(),$(".applyed").hide(),$(".applyed .applyedLeft").html("CODE "),$("#code").val("")},checkPromocode=function(){$(".code .code_err").html("").hide();var d=$("#promocode").val();if(!d)return $(".code_err").html("Please enter the code").show(),!1;$.ajax({url:"/api/coupon/validateCode",type:"POST",data:{code:d,total:$("#original-price").val()},success:function(e){ajaxSuccess(e,function(){e.data&&(updatePrice(null,null,e.data.coupon_price,e.data.total),$(".applyed").show(),$(".applyed .applyedLeft").html("CODE "+d).show(),$(".codeInput").hide(),$("#code").val(d))})}})},btnContinue=function(){var e=!0;$("#payment-paypal").prop("checked")?$(".paymentMethod .paypal").removeClass("err"):($(".paymentMethod .paypal").addClass("err"),e=!1),checkLogin&&(addressField.shipping_id.val()?($(".payment .shipping.addressDetail").removeClass("border"),e&&(e=!0)):($(".payment .shipping.addressDetail").addClass("border"),e=!1),addressField.billing_id.val()?($(".payment .billing.addressDetail").removeClass("border"),e&&(e=!0)):($(".payment .billing.addressDetail").addClass("border"),e=!1)),e&&placeOrder()},placeOrder=function(){$(".common-bg").show(),$(".common-loading").show(),$.ajax({url:"/api/order/create",type:"POST",data:{shipping_id:addressField.shipping_id.val()||"",billing_id:addressField.billing_id.val()||"",coupon_code:addressField.code.val()||"",product_id:addressField.product_id.val()||"",subscription:$("#order_subscription").prop("checked")?1:0},success:function(e){e?200==e.code?window.location.href=e.data:400==e.code&&($(".common-bg").hide(),$(".common-loading").hide(),showMsg(e.message)):($(".common-bg").hide(),$(".common-loading").hide(),showMsg("System busy, Please retry"))}})};$(document).ready(function(){checkLogin||$(".editAddress .editSelect").hide(),$(".billingAddress_check input").on("click",function(){$(this).prop("checked")?(addressField.address_id.val(""),addressOperate.operate="add",addressOperate.shippingInfo?fillUpAddress(addressOperate.shippingInfo,!0):addressOperate.getAllAddress(fillUpShippingAddress)):(-1==$("#select_more").val()?addressOperate.operate="add":addressOperate.operate="edit",addressField.address_id.val($("#select_more").val()))}),$(".addressTittle span.edit,.addressTittle span.add").on("click",function(){var e=$(".editAddress .payment_title span"),d=$(".editAddress .billingAddress_check"),s=$(this).hasClass("add"),a=$(".editAddress .editSelect");addressOperate.operate=s?"add":"edit",$(".billingAddress_check #sameasship").prop("checked",!1),$(this).hasClass("shipping")?(s?(e.html("ADD SHIPPING ADDRESS"),$(".editAddress .editSelect").hide()):(e.html("CHANGE THE SHIPPING ADDRESS"),addressOperate.shippingInfo?fillUpShippingAddress():addressOperate.getAllAddress(fillUpShippingAddress),a.show()),d.hide(),$(".tableLeft .continue").addClass("shipping").removeClass("billing")):(s?(e.html("ADD BILLING ADDRESS"),$(".editAddress .editSelect").hide(),clearAddress()):(e.html("CHANGE THE BILLING ADDRESS"),addressOperate.billingInfo?fillUpBillingAddress():addressOperate.getAllAddress(fillUpBillingAddress),a.show()),addressOperate.shippingInfo||addressField.shipping_id.val()?d.show():d.hide(),$(".tableLeft .continue").addClass("billing").removeClass("shipping")),$(".common-bg").show(),$(".editAddress").show(),openBox()}),$(".editAddress .close").on("click",function(){$(".editAddress .tableList").find("input,select").removeClass("border"),$(".editAddress .tableList").find(".totalerror").hide(),$(".common-bg").hide(),$(".editAddress").hide(),clearAddress(),closeBox()}),$(".editSelect span").on("click",function(){$(this).siblings("ul").toggle()}),$(".right_list .codeInput .apply").on("click",function(){checkPromocode()}),$(".code .applyedRight").on("click",function(){clearCode()}),$(".right_list .continue").on("click",btnContinue),$(".editAddress #select_more").on("change",function(){var e=$(this).val();if(-1==e)return clearAddress(),addressField.address_id.val(""),!(addressOperate.operate="add");$(".billingAddress_check #sameasship").prop("checked",!1),addressField.address_id.val(e),addressOperate.operate="edit";var d=$(".tableLeft .continue").hasClass("shipping")?"shipping":"billing";"shipping"==d?addressOperate.shippingInfo&&(addressField.shipping_id.val(e),fillUpAddress(addressOperate.shippingInfo,!0)):"billing"==d&&addressOperate.billingInfo&&(addressField.billing_id.val(e),fillUpAddress(addressOperate.billingInfo,!0))})});